<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Api Test</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="css/index.css">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet/less" type="text/css" href="css/navs.less" />

    <!-- Custom styles for this template -->
    <link href="css/cover.css" rel="stylesheet">
    <link rel="icon" href="images/favicon.png">
</head>

<body>
    <div>
        <table id="example" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>First</th>
                    <th>Last</th>
                    <th>Phone</th>
                    <th>Nat</th>
                    <th>Location</th>
                    <th>DOB</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin</th>
                </tr>
            </thead>

            <tfoot>
                <tr>
                    <th>First</th>
                    <th>Last</th>
                    <th>Phone</th>
                    <th>Nat</th>
                    <th>Location</th>
                    <th>DOB</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin</th>
                </tr>
            </tfoot>
        </table>

        <!--add user button-->
        <button type="button" class="btn btn-default" id="adduser" data-toggle="modal" data-target="#add_user">Add a User</button>

        <!--modal-->
        <div class="container">
                <div class="row">
        
                    <!-- Add User/Edit User Modal-->
                    <div class="modal fade login-register-form" role="dialog" id="add_user">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">
                                                        <span class="glyphicon glyphicon-remove"></span>
                                                    </button>
                                    <ul class="nav nav-tabs">
                                        
                                        <li class="active"><a data-toggle="tab" href="#add_user-form"> Add User <span class="glyphicon glyphicon-user"></span></a></li>
                                        <li><a data-toggle="tab" href="#edit_user-form"> Edit User <span class="glyphicon glyphicon-pencil"></span></a></li>
                                    </ul>
                                </div>
                                <div class="modal-body">
                                    <div class="tab-content">
                                        
                                        <!--add user modal-->
                                        <div id="add_user-form" class="tab-pane fade in active">
                                            <form method="POST">
                                                <div class="form-group">
                                                    <label for="first-name">First Name:</label>
                                                    <input type="text" class="form-control" id="fname" placeholder="First" name="fname" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="last-name">Last Name:</label>
                                                    <input type="text" class="form-control" id="lname" placeholder="Last" name="lname" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="phone">Phone:</label>
                                                    <input type="text" class="form-control" id="phone-num" placeholder="(xxx)-xxx-xxxx" name="phone_num" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="nat">Nationality:</label>
                                                    <input type="text" class="form-control" id="nat" placeholder="US" name="nat" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="city">City:</label>
                                                    <input type="text" class="form-control" id="city" placeholder="City" name="city" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="dob">Date of Birth:</label>
                                                    <input type="text" class="form-control" id="dob" placeholder="YYYY/MM/DD" name="dob" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="newpwd">Email:</label>
                                                    <input type="email" class="form-control" id="email" placeholder="email" name="email" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="user-name">Username:</label>
                                                    <input type="text" class="form-control" id="user-name" placeholder="user" name="user-name" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="password">Password:</label>
                                                    <input type="password" class="form-control" id="pwd" placeholder="password" name="password">
                                                </div>
                                                <button type="submit" class="btn btn-default">Add User</button>
                                            </form>
                                        </div>
                                        <!--add user modal end-->

                                        <!--edit user modal -->
                                        <div id="edit_user-form" class="tab-pane fade">
                                            <form method="POST">
                                                <div class="form-group">
                                                    <input type="hidden" id="selected_id" name="_id"> <!--id of row selected-->
                                                    <label for="first-name">First Name:</label>
                                                    <input type="text" class="form-control" id="newfname" placeholder="" name="fname" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="last-name">Last Name:</label>
                                                    <input type="text" class="form-control" id="newlname" placeholder="" name="lname" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="phone">Phone:</label>
                                                    <input type="text" class="form-control" id="newphone-num" placeholder="" name="phone_num" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="nat">Nationality:</label>
                                                    <input type="text" class="form-control" id="newnat" placeholder="" name="nat" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="city">City:</label>
                                                    <input type="text" class="form-control" id="newcity" placeholder="" name="city" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="dob">Date of Birth:</label>
                                                    <input type="text" class="form-control" id="newdob" placeholder="" name="dob" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="newpwd">Email:</label>
                                                    <input type="email" class="form-control" id="newemail" placeholder="" name="email" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="user-name">Username:</label>
                                                    <input type="text" class="form-control" id="newuser-name" placeholder="" name="user-name" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="password">Password:</label>
                                                    <input type="text" class="form-control" id="newpwd" placeholder="" name="password">
                                                </div>
                                                <button type="submit" class="btn btn-default">Update</button>
                                            </form>
                                        </div>
                                            <!--edit user modal end-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--modal end-->
        

        <div class="cd-popup" role="alert">
            <div class="cd-popup-container">
                <p>Are you sure you want to delete this element?</p>
                <ul class="cd-buttons">
                    <li><a class="yes_delete" href="">Yes</a></li>
                    <li><a class="no_delete" href="">No</a></li>
                </ul>
                <a href="#0" class="cd-popup-close img-replace">Close</a>
            </div> <!-- cd-popup-container -->
        </div> <!-- cd-popup -->
        
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="js/scripts.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    
    
    <script>
        var del_data;
        var $current_id;
        
        function delete_users() {
            $.ajax({
                url: "http://104.236.8.2/useradmin/api.php/delete_user?_id="+del_data,
                type: 'DELETE',
                success: function(data) {
                    console.log(data);
                    window.location.href = "http://104.236.8.2/useradmin/"; //reload table to show changes
                },
                data: []
            });
        }

        function get_users() {
            $.ajax({
                url: "http://104.236.8.2/useradmin/api.php/find_user",
                type: 'GET',
                success: function(data) {
                    load_data_tables(data);
                },
                data: []
            });
        }

        function load_data_tables(data) {
            var filtered = [];
            var newobj = {
                "data": []
            };
            for (let i = 0; i < data.length; i++) {
                temp = [
                    data[i].first,
                    data[i].last,
                    data[i].phone,
                    data[i].nat,
                    data[i].city,
                    data[i].dob,
                    data[i].email,
                    data[i].username,
                    data[i].password,
                    '<i class="fa fa-pencil-square-o edit_user" aria-hidden="true" data-id="' + data[i]['_id'] + '"></i> <i class="fa fa-trash delete_user cd-popup-trigger" aria-hidden="true" data-id="' + data[i]['_id'] + '"></i>'
                ];
                newobj["data"].push(temp);
            }
            console.log(JSON.stringify(newobj));
            var table = $('#example').DataTable({
                "data": newobj.data,
                "initComplete": function(settings, json) {
                    console.log('DataTables has finished its initialisation.');
                    add_admin_events();
                    $('#example tbody').on('click', 'tr', function() {
                        $(this).toggleClass('selected');
                        console.log(table.row(this).data());
                    });
                }
            });
            table.on('draw', function() {
                console.log('Table redrawn');
                add_admin_events();
            });
        }

        function add_admin_events() {
            $('.delete_user').click(function(event) {
                var $this = $(this);
                del_data = $this.data().id;
                event.preventDefault();
		        $('.cd-popup').addClass('is-visible');
            });

            $('.edit_user').click(function() {
                var $this = $(this);
                $("#selected_id").attr("value",$this.data().id); //id of user to be updated
                $("#add_user").modal("toggle"); //toggle modal on click
                
               //variable to store current table
               var table = $('#example').DataTable();

               //preload table with selected row data
               $('#example tbody').on('click', 'tr', function () {
                    document.getElementById("newfname").defaultValue = table.row(this).data()[0];
                    document.getElementById("newlname").defaultValue = table.row(this).data()[1];
                    document.getElementById("newphone-num").defaultValue = table.row(this).data()[2];
                    document.getElementById("newnat").defaultValue = table.row(this).data()[3];
                    document.getElementById("newcity").defaultValue = table.row(this).data()[4];
                    document.getElementById("newdob").defaultValue = table.row(this).data()[5];
                    document.getElementById("newemail").defaultValue = table.row(this).data()[6];
                    document.getElementById("newuser-name").defaultValue = table.row(this).data()[7];
                    document.getElementById("newpwd").defaultValue = table.row(this).data()[8];
                });
            });
        }

        $("#edit_user-form").submit(function(event){
            //build object to store form data
            console.log($("#selected_id").val());
            event.preventDefault();
            var document = {
                    "_id" : $("#selected_id").val(),
                    "first" : $("#newfname").val(),
                    "last" : $("#newlname").val(),
                    "phone" : $("#newphone-num").val(),
                    "nat" : $('#newnat').val(),
                    "city" : $('#newcity').val(),
                    "dob" : $('#newdob').val(),
                    "email" : $('#newemail').val(),
                    "username" : $('#newuser-name').val(),
                    "password" : $('#newpwd').val()
            }
            url = "http://104.236.8.2/useradmin/api.php/update_user";
            $.ajax({
                type : "POST",
                url : url,
                data : document,
                success : function (data) {
                    console.log(data);
                    window.location.href = "http://104.236.8.2/useradmin/" //reload table to show changes
                }
            });
        });

        $('.yes_delete').click(function(event){
            delete_users(del_data);
            $('.cd-popup').removeClass('is-visible');
        })

        $('.no_delete').click(function(event){
            event.preventDefault();
            $('.cd-popup').removeClass('is-visible');
        })

        $("#add_user-form").submit(function(event){
           //build object to store form data
           event.preventDefault();
           var document = {
                    "first" : $("#fname").val(),
                    "last" : $("#lname").val(),
                    "phone" : $("#phone-num").val(),
                    "nat" : $('#nat').val(),
                    "city" : $('#city').val(),
                    "dob" : $('#dob').val(),
                    "email" : $('#email').val(),
                    "username" : $('#user-name').val(),
                    "password" : $('#pwd').val()
            }
            url = "http://104.236.8.2/useradmin/api.php/add_user";
            $.ajax({
                type : "POST",
                url : url,
                data : document,
                success : function (data) {
                    console.log(data);
                    window.location.href = "http://104.236.8.2/useradmin/" //reload table to show changes
                }
            });
        });

        get_users();
    </script>
</body>

</html>